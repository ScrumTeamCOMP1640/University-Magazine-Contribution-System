@model X.PagedList.IPagedList<Article>

@{
	ViewData["Title"] = "Home Page";
	Layout = "~/Views/Shared/_Layout.cshtml";

	var username = Context.Session.GetString("Username");
	var role = Context.Session.GetString("Role");
}

<div class="main__container">
	@switch (role)
	{
		case "Student":
		case "Guest":
			<img src="~/img/gre.png" class="background">
			break;
		default:
			break;
	}
	<div class="grid wide">
		<div class="row sm-gutter main__content">
			<div class="col l-3 m-0 c-0">
				<table class="category">
					<tbody>
						<tr>
							<th>Faculty</th>
						</tr>
						<tr class="fac">
							<td>Name</td>
							<td class="faculty-name">
								<select name="facultyId" id="facultySelect" @(role != null && role.Contains("Manager") ? "" : "disabled")>
									@foreach (var item in ViewBag.Faculties)
									{
										<option value="@item.FacultyId">@item.FacultyName</option>
									}
								</select>
							</td>
						</tr>
						<tr>
							<td>Status</td>
							<td>
								<p class="status active">Active</p>
							</td>
						</tr>

						<tr>
							<th>Term</th>
							<td class="term-name">
								<select id="termSelect" name="termId">
									@foreach (var item in ViewBag.Terms)
									{
										<option value="@item.TermId">@item.TermName</option>
									}
								</select>
							</td>
						</tr>
						<tr class="date">
							<td>Start Date</td>
							<td id="startDate"></td>
						</tr>
						<tr class="date">
							<td>End Date</td>
							<td id="endDate"></td>
						</tr>
						<tr>
						<tr>
							<td>Status</td>
							<td>
								<p id="termStatus" class="status"></p>
							</td>
						</tr>
					</tbody>
				</table>
			</div>

			<div class="col l-9 m-12 c-12">
				<div class="home-item-list">
					@if (role != null && (role.Contains("Coordinator") || role.Contains("Student")))
					{
						<div class="row sm-gutter">
						<div class="col l-12 m-12 c-12">
							<div class="filter-bar">
								<span>Sort by</span>
								<select name="status" id="statusSelect">
									<option value="All" selected>All</option>
									<option value="Approved">Approved</option>
									<option value="Pending">Pending</option>
									<option value="Rejected">Rejected</option>
								</select>
							</div>
						</div>
					</div>
					}
					<div id="loading">
						<div class="spinner"></div>
					</div>
					<div id="articleList" class="row sm-gutter">
					</div>
				</div>
				<div id="pagination" style="display: none;">
					<ul class="pagination home-product__pagination">
					</ul>
				</div>

			</div>
		</div>
	</div>
</div>

@section ScriptsFilter {
	<script>
		$(document).ready(function () {
			function showLoading() {
				$('#loading').fadeIn(500);
				$('#pagination').hide();
			}

			function hideLoading() {
				$('#loading').fadeOut(500);
				$('#articleList').fadeIn(1000);
			}

			function updateTermDates(termId) {
				$.ajax({
					url: '@Url.Action("GetTermDates", "Home")',
					type: 'GET',
					data: { termId: termId },
					success: function (data) {
						$('#startDate').text(data.startDate);
						$('#endDate').text(data.endDate);
						$('#termStatus').text(data.status);
						var statusClass = data.status.toLowerCase();
						$('#termStatus').removeClass().addClass('status').addClass(statusClass);
					},
					error: function (xhr, status, error) {
						console.error(xhr.responseText);
					}
				});
			}

			function fetchArticles(page, facultyId, termId, searchQuery, status) {
				$.ajax({
					url: '@Url.Action("GetTotalArticleCount", "Home")',
					type: 'GET',
					data: {
						facultyId: facultyId,
						termId: termId,
						searchQuery: searchQuery,
						status: status
					},
					success: function (totalCountData) {
						var total = totalCountData.totalCount;
						var pageSize = 6;
						var pageCount = Math.ceil(total / pageSize);

						$.ajax({
							url: '@Url.Action("GetArticles", "Home")',
							type: 'GET',
							data: {
								page: page,
								facultyId: facultyId,
								termId: termId,
								searchQuery: searchQuery,
								status: status
							},
							beforeSend: function () {
								showLoading();
							},
							success: function (data) {
								$('#articleList').empty();
								setTimeout(function () {
									if (data.trim().length === 0) {
										$('#articleList').html('<div class="col l-12 m-12 c-12"><div class="no-results"><div class="no-results__img" style="background-image: url(@Url.Content("~/img/no_data.svg"))"></div><h2>No data found</h2></div></div>');
										$('#pagination').hide();
									} else {
										$('#articleList').html(data);
										$('#pagination').show();
										updatePagination(page, pageCount);
									}
								}, 1000);
								hideLoading();
							},
							error: function (xhr, status, error) {
								console.error(xhr.responseText);
								hideLoading();
							}
						});
					},
					error: function (xhr, status, error) {
						console.error(xhr.responseText);
					}
				});
			}

			function updatePagination(activePage, totalPages) {
				$('.pagination-item').remove();

				for (let i = 1; i <= totalPages; i++) {
					$('#pagination .home-product__pagination').append(
						$('<li>', { class: 'pagination-item' + (i === parseInt(activePage) ? ' active' : '') }).append(
							$('<a>', { class: 'pagination-item__link', href: '@Url.Action("Index")?page=' + i }).text(i)
						)
					);
				}
			}

			var defaultPage = 1;
			var defaultTermId = $('#termSelect').val();
			var defaultFacultyId = $('#facultySelect').val();
			var defaultSearchQuery = $('#searchInput').val();
			var defaultStatus = $('#statusSelect').val();
			updateTermDates(defaultTermId);
			fetchArticles(defaultPage, defaultFacultyId, defaultTermId, defaultSearchQuery, defaultStatus);

			$('#facultySelect').change(function () {
				var facultyId = $(this).val();
				var termId = $('#termSelect').val();
				var searchQuery = $('#searchInput').val();
				var status = $('#statusSelect').val();
				fetchArticles(defaultPage, facultyId, termId, searchQuery, status);
			});

			$('#termSelect').change(function () {
				var termId = $(this).val();
				var facultyId = $('#facultySelect').val();
				var searchQuery = $('#searchInput').val();
				var status = $('#statusSelect').val();
				updateTermDates(termId);
				fetchArticles(defaultPage, facultyId, termId, searchQuery, status);
			});

			$('#searchInput').on('input', function () {
				var facultyId = $('#facultySelect').val();
				var termId = $('#termSelect').val();
				var searchQuery = $(this).val();
				var status = $('#statusSelect').val();
				fetchArticles(defaultPage, facultyId, termId, searchQuery, status);
			});

			$('#statusSelect').change(function () {
				var facultyId = $('#facultySelect').val();
				var termId = $('#termSelect').val();
				var searchQuery = $('#searchInput').val();
				var status = $(this).val();
				fetchArticles(defaultPage, facultyId, termId, searchQuery, status);
			});

			$(document).on('click', '.pagination-item__link', function (e) {
				e.preventDefault();
				var page = $(this).attr('href').split('=')[1];
				var facultyId = $('#facultySelect').val();
				var termId = $('#termSelect').val();
				var searchQuery = $('#searchInput').val();
				var status = $('#statusSelect').val();
				fetchArticles(page, facultyId, termId, searchQuery, status);
			});

			// $('#downloadAll').on('click', function () {
			// 	var facultyId = $('#facultySelect').val();
			// 	var termId = $('#termSelect').val();

			// 	downloadAllFile(facultyId, termId);
			// });

			// function downloadAllFile(facultyId, termId) {
			// 	$.ajax({
			// 		url: '@Url.Action("DownloadAll", "Submission")',
			// 		type: 'GET',
			// 		data: {
			// 			facultyId: facultyId,
			// 			termId: termId
			// 		},
			// 		success: function (data) {
			// 			console.log("Files downloaded successfully!");
			// 		},
			// 		error: function (xhr, status, error) {
			// 			console.error(xhr.responseText);
			// 		}
			// 	});
			// }

		});
	</script>
}
